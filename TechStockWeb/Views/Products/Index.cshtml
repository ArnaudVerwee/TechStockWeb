@model IEnumerable<TechStockWeb.Models.Product>

@{
    ViewData["Title"] = "Index";
}

<h1>Products</h1>

<p>
    <a asp-action="Create" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Create New
    </a>
</p>

<!-- Formulaire de recherche -->
<form method="get" class="mb-4">
    <div class="row">
        <div class="col-md-3">
            <label for="SearchName">Name</label>
            <input type="text" name="SearchName" class="form-control" value="@ViewData["SearchName"]" />
        </div>

        <div class="col-md-3">
            <label for="SearchSerialNumber">Serial Number</label>
            <input type="text" name="SearchSerialNumber" class="form-control" value="@ViewData["SearchSerialNumber"]" />
        </div>

        <div class="col-md-3">
            <label for="SearchType">Type</label>
            <select name="SearchType" class="form-control">
                <option value="">All</option>
                @foreach (var type in (IEnumerable<SelectListItem>)ViewBag.TypeList)
                {
                    <option value="@type.Value" selected="@(type.Value == ViewData["SearchType"]?.ToString())">@type.Text</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label for="SearchSupplier">Supplier</label>
            <select name="SearchSupplier" class="form-control">
                <option value="">All</option>
                @foreach (var supplier in (IEnumerable<SelectListItem>)ViewBag.SupplierList)
                {
                    <option value="@supplier.Value" selected="@(supplier.Value == ViewData["SearchSupplier"]?.ToString())">@supplier.Text</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label for="SearchUser">User</label>
            <select name="SearchUser" class="form-control">
                <option value="">All</option>
                <option value="NotAssigned" selected="@(ViewData["SearchUser"]?.ToString() == "NotAssigned")">
                    Not Assigned
                </option>
                @foreach (var user in (IEnumerable<SelectListItem>)ViewBag.Users)
                {
                    <option value="@user.Value" selected="@(user.Value == ViewData["SearchUser"]?.ToString())">
                        @user.Text
                    </option>
                }
            </select>
        </div>



    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Search
        </button>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-arrow-clockwise"></i> Reset
        </a>
    </div>
</form>

<!-- Tableau des produits -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model.Name)</th>
            <th>@Html.DisplayNameFor(model => model.SerialNumber)</th>
            <th>@Html.DisplayNameFor(model => model.TypeArticle)</th>
            <th>@Html.DisplayNameFor(model => model.Supplier)</th>
            <th>User</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            // Cast explicite pour éviter l'erreur de type dynamique
            var assignments = (IEnumerable<TechStockWeb.Models.MaterialManagement>)ViewBag.MaterialAssignments;
            var assignment = assignments.FirstOrDefault(m => m.ProductId == item.Id);

            <tr>
                <td>@Html.DisplayFor(modelItem => item.Name)</td>
                <td>@Html.DisplayFor(modelItem => item.SerialNumber)</td>
                <td>@Html.DisplayFor(modelItem => item.TypeArticle.Name)</td>
                <td>@Html.DisplayFor(modelItem => item.Supplier.Name)</td>
                <td>
                    @if (assignment != null)
                    {
                        <span>@assignment.User.UserName</span>
                    }
                    else
                    {
                        <span class="text-muted">Not assigned</span>
                    }
                </td>
                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning btn-sm">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info btn-sm">
                        <i class="bi bi-eye"></i>
                    </a>

                    @if (assignment == null)
                    {
                        <a asp-controller="MaterialManagements" asp-action="AssignToUser" asp-route-id="@item.Id" class="btn btn-primary">
                            Assign to User
                        </a>


                    }
                    else
                    {
                        <form asp-action="UnassignFromUser" asp-route-id="@item.Id" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="bi bi-person-x"></i> Unassign
                            </button>
                        </form>

                    }

                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm">
                        <i class="bi bi-trash"></i>
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>
